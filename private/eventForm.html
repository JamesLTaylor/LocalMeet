<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Event</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .event-form-table {
      width: 100%;
      max-width: 600px;
      border-collapse: separate;
      border-spacing: 0 8px;
      margin-left: 0;
      margin-right: auto;
    }
    .event-form-table td {
      vertical-align: middle;
      padding: 4px 8px;
    }
    .event-form-table label {
      font-weight: bold;
      display: block;
      text-align: right;
      margin-right: 8px;
    }
    .event-form-table input,
    .event-form-table textarea,
    .event-form-table select {
      width: 100%;
      box-sizing: border-box;
    }
    .event-form-label {
      text-align: right;
    }
    .event-form-input {
      text-align: left;
    }
    input[type=checkbox] { width: auto }
    .event-form-actions {
      margin-top: 16px;
      text-align: left;
    }
    .event-form-actions button:not(:first-child) {
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h2>Create Event</h2>
  <form id="eventForm">
    <table class="event-form-table">
      <tr>
        <td class="event-form-label"><label for="title">Title:</label></td>
        <td class="event-form-input"><input type="text" id="title" name="title" required></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="description">Description:</label></td>
        <td class="event-form-input"><textarea id="description" name="description"></textarea></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="date">Date</label></td>
        <td class="event-form-input"><input type="date" id="date" name="date" required></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="startTime">Start Time</label></td>
        <td class="event-form-input"><input type="time" id="startTime" name="startTime" required></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="duration">Duration</label></td>
        <td class="event-form-input">
          <select id="duration" name="duration" required>
            <option value="1h_or_less">1h or less</option>
            <option value="1_to_2">1 to 2 hours</option>
            <option value="2_to_3">2 to 3 hours</option>
            <option value="3_to_4">3 to 4 hours</option>
            <option value="more_than_4">more than 4h</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="locationDescription">Location Description:</label></td>
        <td class="event-form-input"><input type="text" id="locationDescription" name="locationDescription"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="location">Location (address):</label></td>
        <td class="event-form-input"><input type="text" id="location" name="location"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="memberOnly">Regular attendance requires membership?</label></td>
        <td class="event-form-input"><input type="checkbox" id="memberOnly" name="memberOnly"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="externalRegister">External Register Link/Email:</label></td>
        <td class="event-form-input"><input type="text" id="externalRegister" name="externalRegister"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="localMeetRegister">Let users register via LocalMeet:</label></td>
        <td class="event-form-input"><input type="checkbox" id="localMeetRegister" name="localMeetRegister"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="groupTags">Who is this for?</label></td>
        <td class="event-form-input"><input type="text" id="groupTags" name="groupTags"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="categoryTags">What type of event is it?</label></td>
        <td class="event-form-input"><input type="text" id="categoryTags" name="categoryTags"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="contactPerson">Contact Person/Organization:</label></td>
        <td class="event-form-input"><input type="text" id="contactPerson" name="contactPerson"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="contactDetails">Contact Details:</label></td>
        <td class="event-form-input"><input type="text" id="contactDetails" name="contactDetails"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="directContact">Let others see contact details:</label></td>
        <td class="event-form-input"><input type="checkbox" id="directContact" name="directContact"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="cost">Cost:</label></td>
        <td class="event-form-input"><input type="number" id="cost" name="cost" min="0" step="any"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="size">Expected event Size:</label></td>
        <td class="event-form-input">
          <select id="size" name="size">
            <option value="TINY">5-10</option>
            <option value="SMALL">10-20</option>
            <option value="MEDIUM">20-50</option>
            <option value="LARGE">50-100</option>
            <option value="HUGE">100+</option>
          </select>
        </td>
      </tr>
    </table>
    <div class="event-form-actions">
      <button type="button" id="btnSaveEvent">Save Event</button>
      <button type="button" id="btnSaveCreateAnother">Save Event &amp; Create Another</button>
      <button type="button" id="btnCancel">Cancel</button>
    </div>
  </form>
  <script>
    async function populateFormWithRecentEvent() {
      try {
        const res = await fetch('/api/my-most-recent-event');
        const result = await res.json();
        if (result.success && result.event) {
          const event = result.event;
          for (const key in event) {
            const el = document.getElementById(key);
            if (!el) continue;
            if (el.type === 'checkbox') {
              el.checked = event[key] === true || event[key] === 'true';
            } else {
              el.value = event[key] || '';
            }
          }
        }
      } catch (err) {
        // Optionally handle error
      }
    }
    document.addEventListener('DOMContentLoaded', populateFormWithRecentEvent);

    document.getElementById('btnSaveEvent').addEventListener('click', async function(e) {
      e.preventDefault();
      const form = document.getElementById('eventForm');
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        // Convert checkboxes to boolean
        if (form.elements[key] && form.elements[key].type === 'checkbox') {
          data[key] = form.elements[key].checked;
        } else {
          data[key] = value;
        }
      });
      // POST to backend
      try {
        const res = await fetch('/api/createEvent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          alert('Event saved successfully!');
          // Optionally redirect or reset form
        } else {
          alert(result.message || 'Error saving event');
        }
      } catch (err) {
        alert('Error saving event');
      }
    });
  </script>
</body>
</html>
