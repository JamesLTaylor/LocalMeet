<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create Event</title>
  <link rel="stylesheet" href="/style.css">
  <style>
    .event-form-table {
      width: 100%;
      max-width: 600px;
      border-collapse: separate;
      border-spacing: 0 8px;
      margin-left: 0;
      margin-right: auto;
    }
    .event-form-table td {
      vertical-align: middle;
      padding: 4px 8px;
    }
    .event-form-table label {
      font-weight: bold;
      display: block;
      text-align: right;
      margin-right: 8px;
    }
    .event-form-table input,
    .event-form-table textarea,
    .event-form-table select {
      width: 100%;
      box-sizing: border-box;
    }
    .event-form-label {
      text-align: right;
    }
    .event-form-input {
      text-align: left;
    }
    input[type=checkbox] { width: auto }
    .event-form-actions {
      margin-top: 16px;
      text-align: left;
    }
    .event-form-actions button:not(:first-child) {
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <h2>Create Event</h2>
  <form id="eventForm">
    <table class="event-form-table">
      <tr>
        <td class="event-form-label"><label for="title">Title:</label></td>
        <td class="event-form-input"><input type="text" id="title" name="title" required></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="description">Description:</label></td>
        <td class="event-form-input"><textarea id="description" name="description"></textarea></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="date">Date</label></td>
        <td class="event-form-input"><input type="date" id="date" name="date" required></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="startTime">Start Time</label></td>
        <td class="event-form-input"><input type="time" id="startTime" name="startTime" required></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="duration">Duration</label></td>
        <td class="event-form-input">
          <select id="duration" name="duration" required>
            <option value="1h_or_less">1h or less</option>
            <option value="1_to_2">1 to 2 hours</option>
            <option value="2_to_3">2 to 3 hours</option>
            <option value="3_to_4">3 to 4 hours</option>
            <option value="more_than_4">more than 4h</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="locationAddress">Location (address/description):</label></td>
        <td class="event-form-input"><input type="text" id="locationAddress" name="locationAddress"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="locationPostcode">Location (postcode):</label></td>
        <td class="event-form-input"><input type="text" id="locationPostcode" name="locationPostcode"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="memberOnly">Regular attendance requires membership?</label></td>
        <td class="event-form-input"><input type="checkbox" id="memberOnly" name="memberOnly"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="externalRegister">Link/email to register:</label></td>
        <td class="event-form-input">
          <input type="text" id="externalRegister" name="externalRegister" title="Leave blank if there is no registration required">
        </td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="localMeetRegister">Let users register via LocalMeet:</label></td>
        <td class="event-form-input"><input type="checkbox" id="localMeetRegister" name="localMeetRegister"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="groupTags">Who is this for?</label></td>
        <td class="event-form-input"><input type="text" id="groupTags" name="groupTags"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="categoryTags">What type of event is it?</label></td>
        <td class="event-form-input"><input type="text" id="categoryTags" name="categoryTags"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="contactPerson">Contact Person/Organization:</label></td>
        <td class="event-form-input"><input type="text" id="contactPerson" name="contactPerson"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="contactDetails">Contact Details:</label></td>
        <td class="event-form-input"><input type="text" id="contactDetails" name="contactDetails"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="contactVisibility">Contact visibility:</label></td>
        <td class="event-form-input">
          <select id="contactVisibility" name="contactVisibility" title="Who can see the contact details?&#013LocalMeetDirect=users can message you but will not see your email until you reply.&#013LoggedIn=logged in users can see your email address.&#013Public=everyone can see your email address.">
            <option value="NOBODY" selected="selected">Nobody</option>
            <option value="LOCAL_MEET_DIRECT">LocalMeetDirect</option>
            <option value="LOGGED_IN">LoggedIn</option>
            <option value="PUBLIC">Everyone</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="costIntroductory">Cost (introductory):</label></td>
        <td class="event-form-input"><input type="number" id="costIntroductory" name="costIntroductory" min="0" step="1"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="costRegular">Cost (regular):</label></td>
        <td class="event-form-input"><input type="number" id="costRegular" name="costRegular" min="0" step="1"></td>
      </tr>
      <tr>
        <td class="event-form-label"><label for="size">Expected event Size:</label></td>
        <td class="event-form-input">
          <select id="size" name="size">
            <option value="TINY">5-10</option>
            <option value="SMALL" selected="selected">10-20</option>
            <option value="MEDIUM">20-50</option>
            <option value="LARGE">50-100</option>
            <option value="HUGE">100+</option>
          </select>
        </td>
      </tr>
    </table>
    <div class="event-form-actions">
      <button type="button" id="btnSaveEvent">Save Event</button>
      <button type="button" id="btnSaveCreateAnother">Save Event &amp; Create Another</button>
      <button type="button" id="btnCancel">Cancel</button>
    </div>
  </form>
  <div id="eventIdDisplay" style="position: fixed; bottom: 10px; right: 20px; font-size: 0.85em; color: #888; background: #f9f9f9; padding: 4px 10px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.04);">
    Event ID: <span id="eventIdText"></span>
  </div>
  <script>
    async function populateFormWithRecentEvent() {
      try {
        const res = await fetch('/api/my-most-recent-event');
        const result = await res.json();
        if (result.success && result.event) {
          const event = result.event;
          for (const key in event) {
            const el = document.getElementById(key);
            if (!el) continue;
            if (el.type === 'checkbox') {
              el.checked = event[key] === true || event[key] === 'true';
            } else if (el.type === 'date' && event[key]) {
              // Convert to yyyy-mm-dd for input[type=date]
              const d = new Date(event[key]);
              if (!isNaN(d)) {
                el.value = d.toISOString().slice(0, 10);
                // Also set time field if present
                const timeEl = document.getElementById('startTime');
                if (timeEl && d instanceof Date && !isNaN(d)) {
                  // Pad hours/minutes to 2 digits
                  const hh = String(d.getHours()).padStart(2, '0');
                  const mm = String(d.getMinutes()).padStart(2, '0');
                  timeEl.value = `${hh}:${mm}`;
                }
              } else {
                el.value = '';
              }
            } else {
              el.value = event[key] || '';
            }
          }
          // Set eventId display
          document.getElementById('eventIdText').textContent = event.eventId || '';
        } else {
          // If no recent event, set eventId to current timestamp
        }
      } catch (err) {
        // On error, set eventId to current timestamp if not already set
      }
    }
    document.addEventListener('DOMContentLoaded', populateFormWithRecentEvent);

    // Ensure eventId is set on form creation if not populated
    document.addEventListener('DOMContentLoaded', function() {
      if (!document.getElementById('eventIdText').textContent) {
        document.getElementById('eventIdText').textContent = Date.now();
      }
    });

    document.getElementById('btnSaveEvent').addEventListener('click', async function(e) {
      e.preventDefault();
      const form = document.getElementById('eventForm');
      const formData = new FormData(form);
      const data = {};
      formData.forEach((value, key) => {
        // Convert checkboxes to boolean
        if (form.elements[key] && form.elements[key].type === 'checkbox') {
          data[key] = form.elements[key].checked;
        } else {
          data[key] = value;
        }
      });
      // POST to backend
      try {
        // Add eventId to data
        data.eventId = document.getElementById('eventIdText').textContent;
        const res = await fetch('/api/createEvent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        if (result.success) {
          alert('Event saved successfully!');
          // Optionally redirect or reset form
        } else {
          alert(result.message || 'Error saving event');
        }
      } catch (err) {
        alert('Error saving event');
      }
    });

    document.getElementById('btnCancel').addEventListener('click', function(e) {
      e.preventDefault();
      window.location.href = '/';
    });
  </script>
</body>
</html>
